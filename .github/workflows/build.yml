name: Build and Test

permissions:
  contents: read

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-linux:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        qt-version: ['6.5.3']
        build-type: [Release, Debug]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ matrix.qt-version }}
        modules: 'qtwebsockets qtmultimedia qtpositioning qtconnectivity'
    
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          dpkg-dev \
          qt6-base-dev \
          qt6-websockets-dev \
          qt6-multimedia-dev \
          qt6-positioning-dev \
          qt6-connectivity-dev
    
    - name: Configure CMake
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=${{ matrix.build-type }} \
          -DBUILD_TESTS=ON \
          -DBUILD_EXTENSIONS=ON \
          -G Ninja
    
    - name: Build
      run: cmake --build build --config ${{ matrix.build-type }}
    
    - name: Package DEB
      if: matrix.build-type == 'Release'
      working-directory: build
      run: |
        cpack -G DEB

    - name: Run Tests
      working-directory: build
      run: ctest -C ${{ matrix.build-type }} --output-on-failure
    
    - name: Upload Artifacts
      if: matrix.build-type == 'Release'
      uses: actions/upload-artifact@v4
      with:
        name: crankshaft-reborn-linux-${{ matrix.qt-version }}
        path: |
          build/CrankshaftReborn
          build/libCrankshaftCore.a
          build/libCrankshaftExtensions.a
          build/*.deb

  build-debian:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        arch: [amd64, armhf, arm64]
        debian-version: [trixie]
        build-type: [Release, Debug]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up QEMU
      if: matrix.arch != 'amd64'
      uses: docker/setup-qemu-action@v3
      with:
        platforms: arm,arm64
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build for ${{ matrix.arch }}
      run: |
        # Map architecture names for Docker platform
        PLATFORM="linux/${{ matrix.arch }}"
        if [ "${{ matrix.arch }}" = "armhf" ]; then
          PLATFORM="linux/arm/v7"
        fi
        
        # Build using Docker with optional QEMU emulation
        docker buildx build \
          --platform ${PLATFORM} \
          --build-arg BUILD_TYPE=${{ matrix.build-type }} \
          --build-arg DEBIAN_VERSION=${{ matrix.debian-version }} \
          --tag crankshaft-reborn:${{ matrix.arch }}-${{ matrix.debian-version }}-${{ matrix.build-type }} \
          --load \
          -f Dockerfile \
          .
    
    - name: Extract Binaries
      run: |
        mkdir -p build-output
        CONTAINER_ID=$(docker create crankshaft-reborn:${{ matrix.arch }}-${{ matrix.debian-version }}-${{ matrix.build-type }})
        docker cp ${CONTAINER_ID}:/output/. ./build-output/
        docker rm ${CONTAINER_ID}
        echo "Built files:"
        ls -lh build-output/
    
    - name: Upload Artifacts
      if: matrix.build-type == 'Release'
      uses: actions/upload-artifact@v4
      with:
        name: crankshaft-reborn-${{ matrix.arch }}-${{ matrix.debian-version }}-${{ matrix.build-type }}
        path: |
          build-output/CrankshaftReborn
          build-output/libCrankshaftCore.a
          build-output/libCrankshaftExtensions.a
          build-output/*.so*
          build-output/*.deb
    
  code-quality:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install Dev Tools
      run: |
        bash ./scripts/install_dev_tools.sh
    
    - name: Check Code Formatting
      run: |
        bash ./scripts/lint_cpp.sh format-check
    
    - name: Run Cppcheck
      run: |
        bash ./scripts/lint_cpp.sh cppcheck

    - name: Configure CMake (for clang-tidy)
      run: |
        cmake -S . -B build -DCMAKE_BUILD_TYPE=Debug -DBUILD_TESTS=ON -G Ninja -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

    - name: Run clang-tidy
      env:
        LC_ALL: C.UTF-8
      run: |
        bash ./scripts/lint_cpp.sh clang-tidy
