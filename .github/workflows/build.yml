name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-linux:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        qt-version: ['6.5.3']
        build-type: [Release, Debug]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ matrix.qt-version }}
        modules: 'qtwebsockets qtmultimedia qtpositioning qtconnectivity'
    
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          dpkg-dev \
          qt6-base-dev \
          qt6-websockets-dev \
          qt6-multimedia-dev \
          qt6-positioning-dev \
          qt6-connectivity-dev
    
    - name: Configure CMake
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=${{ matrix.build-type }} \
          -DBUILD_TESTS=ON \
          -DBUILD_EXTENSIONS=ON \
          -G Ninja
    
    - name: Build
      run: cmake --build build --config ${{ matrix.build-type }}
    
    - name: Package DEB
      if: matrix.build-type == 'Release'
      working-directory: build
      run: |
        cpack -G DEB

    - name: Run Tests
      working-directory: build
      run: ctest -C ${{ matrix.build-type }} --output-on-failure
    
    - name: Upload Artifacts
      if: matrix.build-type == 'Release'
      uses: actions/upload-artifact@v4
      with:
        name: crankshaft-reborn-linux-${{ matrix.qt-version }}
        path: |
          build/CrankshaftReborn
          build/libCrankshaftCore.a
          build/libCrankshaftExtensions.a
          build/*.deb

  build-raspberry-pi:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        arch: [armhf, arm64]
        debian-version: [bookworm, trixie]
        build-type: [Release, Debug]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      with:
        platforms: arm,arm64
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build for ${{ matrix.arch }}
      run: |
        # Map architecture names
        PLATFORM="linux/${{ matrix.arch }}"
        if [ "${{ matrix.arch }}" = "armhf" ]; then
          PLATFORM="linux/arm/v7"
        fi
        
        # Build using Docker with QEMU emulation
        docker buildx build \
          --platform ${PLATFORM} \
          --build-arg BUILD_TYPE=${{ matrix.build-type }} \
          --build-arg TARGET_ARCH=${{ matrix.arch }} \
          --build-arg DEBIAN_VERSION=${{ matrix.debian-version }} \
          --tag crankshaft-reborn-${{ matrix.arch }}:${{ matrix.build-type }} \
          --load \
          -f Dockerfile.rpi \
          .
    
    - name: Extract Binaries
      run: |
        # Create output directory
        mkdir -p build-output
        
        # Extract built binaries from container
        CONTAINER_ID=$(docker create crankshaft-reborn-${{ matrix.arch }}:${{ matrix.build-type }}-${{ matrix.debian-version }})
        docker cp ${CONTAINER_ID}:/output/. ./build-output/
        docker rm ${CONTAINER_ID}
        
        # List what was built
        echo "Built files:"
        ls -lh build-output/
    
    - name: Upload Artifacts
      if: matrix.build-type == 'Release'
      uses: actions/upload-artifact@v4
      with:
        name: crankshaft-reborn-${{ matrix.arch }}-${{ matrix.debian-version }}-${{ matrix.build-type }}
        path: |
          build-output/CrankshaftReborn
          build-output/libCrankshaftCore.a
          build-output/libCrankshaftExtensions.a
          build-output/*.so*
          build-output/*.deb

  build-debian:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        debian-version: [bookworm, trixie]
        build-type: [Release, Debug]
    steps:
    - uses: actions/checkout@v3
    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
    - name: Build (amd64) for ${{ matrix.debian-version }}
      run: |
        docker buildx build \
          --platform linux/amd64 \
          --build-arg BUILD_TYPE=${{ matrix.build-type }} \
          --build-arg DEBIAN_VERSION=${{ matrix.debian-version }} \
          --tag crankshaft-reborn-amd64:${{ matrix.build-type }}-${{ matrix.debian-version }} \
          --load \
          -f Dockerfile.debian \
          .
    - name: Extract Binaries
      run: |
        mkdir -p build-output
        CONTAINER_ID=$(docker create crankshaft-reborn-amd64:${{ matrix.build-type }}-${{ matrix.debian-version }})
        docker cp ${CONTAINER_ID}:/output/. ./build-output/
        docker rm ${CONTAINER_ID}
        echo "Built files:"; ls -lh build-output/
    - name: Upload Artifacts
      if: matrix.build-type == 'Release'
      uses: actions/upload-artifact@v4
      with:
        name: crankshaft-reborn-amd64-${{ matrix.debian-version }}-${{ matrix.build-type }}
        path: |
          build-output/CrankshaftReborn
          build-output/libCrankshaftCore.a
          build-output/libCrankshaftExtensions.a
          build-output/*.so*
          build-output/*.deb
    
  code-quality:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          clang-format \
          cppcheck
    
    - name: Check Code Formatting
      run: |
        find src -name '*.cpp' -o -name '*.hpp' | xargs clang-format --dry-run --Werror || true
    
    - name: Run Cppcheck
      run: |
        cppcheck --enable=all --inconclusive --std=c++17 \
          --suppress=missingIncludeSystem \
          src/ || true
